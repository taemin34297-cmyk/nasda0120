<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{layout/header :: head}"></th:block>
    <title>회원가입 - 나의 스티커 다이어리</title>
    <style>
        :root {
            --primary-beige: #d2c5b0;
            --secondary-beige: #eaddca;
            --bg-white: #f9f7f2;
            --bg-cream: #ffffff;
            --text-dark: #6b5d4d;
            --text-medium: #a69a8b;
            --border-light: #e0d8c8;
            --font-sans: 'Pretendard', sans-serif;
            --font-serif: 'serif';
        }

        .signup-page {
            min-height: 100vh;
            background: var(--bg-white);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem 1.5rem;
        }

        .signup-container {
            width: 100%;
            max-width: 30rem;
            margin: 0 auto;
            background: white;
            padding: 3rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
        }

        .signup-logo {
            text-align: center;
            margin-bottom: 3rem;
        }

        .signup-logo h1 {
            font-family: var(--font-serif);
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
            cursor: pointer;
        }

        .signup-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            display: block;
            font-family: var(--font-sans);
            color: var(--text-dark);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-cream);
            border: 1px solid var(--border-light);
            border-radius: 0.75rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            box-shadow: 0 0 0 2px var(--secondary-beige);
        }

        .input-with-button {
            display: flex;
            gap: 0.5rem;
        }

        .input-wrapper {
            position: relative;
        }

        .btn-check {
            padding: 0.75rem 1rem;
            background: var(--text-dark);
            color: white;
            border: none;
            border-radius: 0.75rem;
            cursor: pointer;
            white-space: nowrap;
        }

        .input-icon-btn {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-medium);
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .help-text {
            font-family: var(--font-sans);
            font-size: 0.875rem;
            margin-top: 0.5rem;
            display: none;
        }

        .help-text.success {
            color: #22c55e;
            display: block;
        }

        .help-text.error {
            color: #ef4444;
            display: block;
        }

        .btn-submit {
            width: 100%;
            padding: 0.75rem;
            background: var(--primary-beige);
            color: white;
            border: none;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
        }

        .signup-footer {
            margin-top: 1.5rem;
            text-align: center;
            color: var(--text-medium);
        }

        .signup-footer a {
            color: var(--text-dark);
            text-decoration: underline;
        }
    </style>
</head>
<body>
<div th:replace="~{layout/header :: header}"></div>

<div class="signup-page">
    <div class="signup-container">
        <div class="signup-logo">
            <h1 onclick="window.location.href='/'">나의 스티커 다이어리</h1>
            <p>나의 영감 저장소에 오신 것을 환영합니다</p>
        </div>

        <form th:action="@{/user/signup}" method="post" class="signup-form" id="signupForm">

            <div class="form-group">
                <label for="username" class="form-label">아이디</label>
                <div class="input-with-button">
                    <input type="text" id="username" name="loginId"
                           class="form-input" style="background-color: white;"
                           placeholder="아이디를 입력하세요" required>
                    <button type="button" class="btn-check" onclick="checkUsername()">중복 확인</button>
                </div>
                <p id="usernameCheck" class="help-text"></p>
            </div>

            <div class="form-group">
                <label for="nickname" class="form-label">닉네임</label>
                <div class="input-with-button">
                    <input type="text" id="nickname" name="nickname" class="form-input" placeholder="2~10자 이내" required>
                    <button type="button" class="btn-check" onclick="checkNickname()">중복 확인</button>
                </div>
                <p id="nicknameCheck" class="help-text"></p>
            </div>

            <div class="form-group">
                <label for="email" class="form-label">이메일</label>
                <div class="input-with-button">
                    <input type="email" id="email" name="email"
                           class="form-input" style="background-color: white;"
                           placeholder="example@naver.com" required>
                    <button type="button" class="btn-check" onclick="sendEmailCode()"
                            style="background-color: #6d6158 !important; color: white !important;">번호 받기</button>
                </div>
                <p id="emailCheck" class="help-text"></p>
            </div>

            <div class="form-group">
                <label for="authCode" class="form-label">인증번호</label>
                <div class="input-with-button" style="position: relative; z-index: 1;"> <input type="text" id="authCode" class="form-input"
                                                                                               style="background-color: white;" placeholder="6자리 숫자 입력">
                    <button type="button" class="btn-check" id="verifyBtn" onclick="verifyEmailCode()"
                            style="background-color: #6d6158 !important; color: white !important; cursor: pointer; position: relative; z-index: 2;">
                        인증 확인
                    </button>
                </div>
                <p id="verify-msg" class="help-text" style="min-height: 20px; margin-top: 5px;"></p>
            </div>

            <div class="form-group">
                <label for="password" class="form-label">비밀번호</label>
                <div class="input-wrapper">
                    <input type="password" id="password" name="password" class="form-input" placeholder="6자 이상 입력"
                           required minlength="6">
                    <button type="button" class="input-icon-btn" onclick="togglePassword('password', 'eyeIcon1')">
                        <svg id="eyeIcon1" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                             stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label for="confirmPassword" class="form-label">비밀번호 확인</label>
                <div class="input-wrapper">
                    <input type="password" id="confirmPassword" class="form-input" placeholder="비밀번호 재입력" required>
                    <button type="button" class="input-icon-btn"
                            onclick="togglePassword('confirmPassword', 'eyeIcon2')">
                        <svg id="eyeIcon2" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                             stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </button>
                </div>
                <p id="passwordCheck" class="help-text"></p>
            </div>

            <button type="submit" class="btn-submit">가입하기</button>
        </form>

        <div class="signup-footer">
            <p>이미 계정이 있으신가요? <a th:href="@{/user/login}">로그인</a></p>
        </div>
    </div>
</div>

<script>
    let usernameChecked = false;
    let usernameAvailable = false;
    let nicknameChecked = false;
    let nicknameAvailable = false;

    // 1. 아이디 중복 확인// ⚠️ 반드시 기존의 checkUsername 함수들을 삭제하고 아래 하나만 남기세요.
    async function checkUsername() {
        const usernameInput = document.getElementById('username');
        const checkElement = document.getElementById('usernameCheck');

        // 정규표현식: 영문 소문자와 숫자만 허용 (자음/모음 자동 차단)
        const idRegex = /^[a-z0-9]{3,15}$/;

        if (!usernameInput) {
            console.error("아이디 입력창(id='username')을 찾을 수 없습니다.");
            return;
        }

        const username = usernameInput.value.trim();

        // 1단계: 빈 값 및 길이 검사
        if (!username || username.length < 3) {
            showMessage(checkElement, '아이디는 3자 이상이어야 합니다.', 'error');
            return;
        }

        // 2단계: 정규식 검사 (여기서 사용하므로 이제 회색으로 뜨지 않습니다)
        if (!idRegex.test(username)) {
            showMessage(checkElement, '아이디는 영문 소문자와 숫자만 사용 가능합니다.', 'error');
            return;
        }

        try {
            const response = await fetch(`/api/member/check-loginId?loginId=${encodeURIComponent(username)}`);

            // Security 권한 문제 등으로 HTML이 반환되는지 체크
            if (!response.ok || response.headers.get("content-type").includes("text/html")) {
                throw new Error("서버 응답 오류 (권한 설정을 확인하세요)");
            }

            const isDuplicate = await response.json();
            isDuplicate ? showMessage(checkElement, '✗ 이미 사용 중인 아이디입니다.', 'error')
                : showMessage(checkElement, '✓ 사용 가능한 아이디입니다.', 'success');
        } catch (e) {
            console.error(e);
            showMessage(checkElement, '확인 중 오류가 발생했습니다.', 'error');
        }
    }

    // 2. 닉네임 중복 확인
    async function checkNickname() {
        const nickname = document.getElementById('nickname').value.trim();
        const checkElement = document.getElementById('nicknameCheck');

        const nicknameRegex = /^[가-힣a-zA-Z0-9]{2,10}$/;

        if (!nicknameRegex.test(nickname)) {
            showMessage(checkElement, '닉네임은 완성된 한글, 영문, 숫자 2~10자만 가능합니다.', 'error');
            return;
        }
        try {
            const response = await fetch(`/api/member/check-nickname?nickname=${encodeURIComponent(nickname)}`);
            const isDuplicate = await response.json();

            nicknameChecked = true;
            nicknameAvailable = !isDuplicate;
            isDuplicate ? showMessage(checkElement, '✗ 이미 사용 중인 닉네임입니다.', 'error')
                : showMessage(checkElement, '✓ 사용 가능한 닉네임입니다.', 'success');
        } catch (e) {
            showMessage(checkElement, '확인 중 오류가 발생했습니다.', 'error');
        }
    }

    // 3. 이메일 형식 검사
    document.getElementById('email').addEventListener('blur', function () {
        const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        const checkElement = document.getElementById('emailCheck');
        if (!this.value) {
            checkElement.style.display = 'none';
            return;
        }
        emailRegex.test(this.value) ? showMessage(checkElement, '✓ 올바른 이메일 형식입니다.', 'success')
            : showMessage(checkElement, '✗ 올바른 이메일 형식을 입력해주세요.', 'error');
    });

    // 4. 비밀번호 표시 토글
    function togglePassword(inputId, iconId) {
        const input = document.getElementById(inputId);
        const icon = document.getElementById(iconId);
        if (input.type === 'password') {
            input.type = 'text';
            icon.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>';
        } else {
            input.type = 'password';
            icon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
        }
    }

    // 5. 비밀번호 일치 실시간 확인
    document.getElementById('confirmPassword').addEventListener('input', function () {
        const checkElement = document.getElementById('passwordCheck');
        const isMatch = this.value === document.getElementById('password').value;
        isMatch ? showMessage(checkElement, '✓ 비밀번호가 일치합니다.', 'success')
            : showMessage(checkElement, '✗ 비밀번호가 일치하지 않습니다.', 'error');
    });

    function showMessage(el, msg, cls) {
        el.textContent = msg;
        el.className = `help-text ${cls}`;
        el.style.display = 'block';
    }

    // 제출 전 최종 검사
    document.getElementById('signupForm').addEventListener('submit', function (e) {
        if (document.getElementById('password').value !== document.getElementById('confirmPassword').value) {
            alert('비밀번호가 일치하지 않습니다.');
            e.preventDefault();
        }
    });

</script>
<script th:inline="javascript">
    let isEmailVerified = false;

    function verifyEmailCode() {
        // 1. 함수 호출 확인용 알림
        console.log("인증 확인 버튼 클릭됨");

        const codeInput = document.getElementById('authCode');
        const msg = document.getElementById('verify-msg');

        if (!codeInput || !codeInput.value) {
            alert("인증번호를 입력해주세요.");
            return;
        }

        const code = codeInput.value;

        // 2. 서버에 인증 확인 요청
        fetch('/user/verify-code?code=' + code, { method: 'POST' })
            .then(res => res.json())
            .then(isSuccess => {
                if (isSuccess) {
                    alert("인증에 성공하였습니다! :)");
                    msg.innerText = "인증이 완료되었습니다. :)";
                    msg.style.color = "#8a7b6a";
                    isEmailVerified = true;

                    // 입력창 잠금
                    document.getElementById('email').readOnly = true;
                    codeInput.readOnly = true;
                } else {
                    alert("인증번호가 틀렸습니다. 다시 확인해주세요.");
                    msg.innerText = "인증번호가 틀렸습니다.";
                    msg.style.color = "red";
                    isEmailVerified = false;
                }
            })
            .catch(error => {
                console.error("에러 발생:", error);
                alert("서버 통신 중 오류가 발생했습니다.");
            });
    }

    // 폼 전송 차단 로직
    const signupForm = document.getElementById('signupForm');
    if (signupForm) {
        signupForm.onsubmit = function() {
            if (!isEmailVerified) {
                alert("이메일 인증을 완료해야 가입이 가능합니다.");
                return false;
            }
            return true;
        };
    }
</script>
</body>
</html>
</body>
</html>