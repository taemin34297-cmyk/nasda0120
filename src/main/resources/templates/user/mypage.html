<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout/header :: head}"></head>

<body class="bg-[#F9F6F1]">
<div th:replace="~{layout/header :: header}"></div>

<main class="max-w-6xl mx-auto py-12 px-6 flex gap-10">
    <aside class="w-64 shrink-0 space-y-3">
        <h2 class="text-lg font-bold text-[#5A4D41] mb-6 px-2">ë§ˆì´í˜ì´ì§€</h2>

        <button onclick="switchTab('activity')" id="tab-btn-activity"
                class="w-full flex justify-between items-center p-4 rounded-xl transition-all bg-[#D4C4B0] text-white shadow-sm">
            <span class="font-medium">âœ¨ ë‚˜ì˜ í™œë™</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </button>

        <button onclick="switchTab('account')" id="tab-btn-account"
                class="w-full flex justify-between items-center p-4 rounded-xl transition-all bg-white text-[#8B7355] border border-[#E8D5C4]/50 hover:bg-[#F2ECE4]">
            <span class="font-medium">âš™ï¸ ê³„ì • ê´€ë¦¬</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </button>

        <button onclick="switchTab('reports')" id="tab-btn-reports"
                class="w-full flex justify-between items-center p-4 rounded-xl transition-all bg-white text-[#8B7355] border border-[#E8D5C4]/50 hover:bg-[#F2ECE4]">
            <span class="font-medium">ğŸš¨ ì‹ ê³  ë‚´ì—­</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </button>
    </aside>

    <section class="flex-1 min-h-[600px]">

        <div id="content-activity" class="space-y-6">
            <h3 class="text-xl font-bold text-[#5A4D41] mb-6">ë‚˜ì˜ í™œë™</h3>

            <div class="grid grid-cols-3 gap-4">
                <div th:onclick="|location.href='@{/posts/my}'|"
                     class="bg-white p-6 rounded-2xl border border-[#E8D5C4]/30 shadow-sm cursor-pointer hover:bg-[#F2ECE4] transition-all">
                    <p class="text-[#A89080] text-sm mb-2">ì‘ì„±í•œ ê²Œì‹œë¬¼</p>
                    <p class="text-2xl font-bold text-[#5A4D41]">
                        <span th:text="${postCount != null ? postCount : 0}">0</span>
                        <span class="text-base ml-1">ê°œ</span>
                    </p>
                </div>

                <div th:onclick="|location.href='@{/comments/my}'|"
                     class="bg-white p-6 rounded-2xl border border-[#E8D5C4]/30 shadow-sm cursor-pointer hover:bg-[#F2ECE4] transition-all">
                    <p class="text-[#A89080] text-sm mb-2">ì‘ì„±í•œ ëŒ“ê¸€</p>
                    <p class="text-2xl font-bold text-[#5A4D41]">
                        <span th:text="${commentCount != null ? commentCount : 0}">0</span>
                        <span class="text-base ml-1">ê°œ</span>
                    </p>
                </div>
            </div>
            <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

            <div id="calendar" class="mb-8 bg-white p-6 rounded-2xl shadow-sm"></div>

            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    var calendarEl = document.getElementById('calendar');
                    var calendar = new FullCalendar.Calendar(calendarEl, {
                        initialView: 'dayGridMonth',
                        locale: 'ko',
                        height: 'auto',
                        headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
                        events: '/api/posts/my/calendar',

                        eventContent: function(arg) {
                            let imageUrl = arg.event.extendedProps.image;
                            if (imageUrl) {
                                // âœ… ì—‘ë°• ë°©ì§€ í•µì‹¬: ì£¼ì†Œ ì•ì— /ê°€ ì—†ìœ¼ë©´ ê°•ì œë¡œ ë¶™ì—¬ì¤ë‹ˆë‹¤.
                                let safeUrl = imageUrl.startsWith('/') ? imageUrl : '/' + imageUrl;

                                return {
                                    html: `<div class="calendar-post-img-wrapper" style="width: 100%; height: 100%;">
                                 <img src="${safeUrl}" class="calendar-event-img"
                                      style="width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 6px;">
                               </div>`
                                };
                            }
                        },
                        eventClick: function(info) {
                            if (info.event.url) {
                                window.location.href = info.event.url;
                                info.jsEvent.preventDefault();
                            }
                        }
                    });
                    calendar.render();
                });
            </script>

            <style>
                /* 1. ì „ì²´ ë°°ê²½ ë° í…Œë‘ë¦¬ */
                #calendar {
                    max-width: 1000px;
                    margin: 40px auto;
                    padding: 30px;
                    background-color: #F9F6F1; /* í™ˆí˜ì´ì§€ ë² ì´ì§€ ë°°ê²½ìƒ‰ */
                    border-radius: 24px;
                    border: 1px solid #E8D5C4;
                    font-family: 'Pretendard', sans-serif;
                }

                /* 2. ìƒë‹¨ íˆ´ë°” (ì œëª© ë° ë²„íŠ¼) */
                .fc-header-toolbar {
                    margin-bottom: 2em !important;
                }

                .fc-toolbar-title {
                    color: #8B7355 !important; /* ê°ˆìƒ‰ í°íŠ¸ */
                    font-weight: 700 !important;
                    font-size: 1.5rem !important;
                }

                /* 3. ë²„íŠ¼ ìŠ¤íƒ€ì¼ ìˆ˜ì • */
                .fc-button-primary {
                    background-color: #D4C4B0 !important; /* ì—°í•œ ê°ˆìƒ‰ ë²„íŠ¼ */
                    border: none !important;
                    border-radius: 10px !important;
                    color: white !important;
                    transition: all 0.2s;
                }

                .fc-button-primary:hover {
                    background-color: #8B7355 !important;
                }

                .fc-button-active {
                    background-color: #8B7355 !important;
                }

                /* 4. ìš”ì¼ ë° ë‚ ì§œ ìˆ«ì */
                .fc-col-header-cell-cushion {
                    color: #8B7355 !important;
                    padding: 10px 0 !important;
                }

                .fc-daygrid-day-number {
                    color: #A89080 !important;
                    padding: 10px !important;
                }

                /* 5. ìº˜ë¦°ë” ì¹¸ ì´ë¯¸ì§€ ë°•ìŠ¤ */
                .calendar-post-img-wrapper {
                    margin-top: 4px;
                    padding: 2px;
                    transition: transform 0.2s;
                }

                .calendar-post-img-wrapper:hover {
                    transform: scale(1.05); /* ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ì‚´ì§ ì»¤ì§ */
                }

                .calendar-event-img {
                    width: 100%;
                    aspect-ratio: 1/1;
                    object-fit: cover;
                    border-radius: 12px;
                    border: 2px solid white;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
                }

                /* 6. ì˜¤ëŠ˜ ë‚ ì§œ í‘œì‹œ */
                .fc-day-today {
                    background-color: rgba(212, 196, 176, 0.2) !important;
                }
            </style>

            <div class="mt-10">
                <h4 class="text-[#8B7355] font-semibold mb-4">ìµœê·¼ ì‘ì„±í•œ ê²Œì‹œë¬¼</h4>

                <div class="grid grid-cols-2 gap-4"
                     th:if="${myPosts != null and !myPosts.isEmpty()}">

                    <div th:each="post : ${myPosts}"
                         th:if="${post != null}"
                         th:onclick="|location.href='/posts/' + ${post.id}|"
                         class="bg-white rounded-xl overflow-hidden border border-[#E8D5C4]/20 shadow-sm cursor-pointer hover:shadow-md transition-all">

                        <img th:if="${post.images != null and !post.images.isEmpty()}"
                             th:src="@{${post.images[0]}}"
                             class="w-full h-32 object-cover"/>
                        <div th:unless="${post.images != null and !post.images.isEmpty()}"
                             class="w-full h-32 bg-[#F2ECE4] flex items-center justify-center text-[#A89080] text-xs">
                            No Image
                        </div>

                        <div class="p-4">
                            <p class="font-medium text-[#5A4D41] truncate"
                               th:text="${post.title}">ì œëª©</p>
                            <p class="text-xs text-[#A89080]"
                               th:text="${#temporals.format(post.createdAt, 'yyyy.MM.dd')}">ë‚ ì§œ</p>
                        </div>
                    </div>
                </div>

                <div th:if="${myPosts == null or myPosts.isEmpty()}"
                     class="py-20 text-center bg-white rounded-2xl border border-dashed border-[#E8D5C4]">
                    <p class="text-[#A89080]">ì•„ì§ ì‘ì„±í•œ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>
        <div id="content-reports" class="hidden space-y-6">
            <h3 class="text-xl font-bold text-[#5A4D41] mb-6">ğŸš¨ ì‹ ê³  ë‚´ì—­</h3>
            <div class="space-y-4">
                <div th:each="reason : ${dummyReports}"
                     class="bg-white p-6 rounded-2xl border border-red-100 shadow-sm flex flex-col gap-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="inline-block px-2 py-0.5 rounded text-[10px] font-bold bg-red-50 text-red-500 mb-2">ì‹ ê³  ì ‘ìˆ˜</span>
                            <h3 class="text-lg font-bold text-[#5A4D41]" th:text="${reason}">ë”ë¯¸ ì‚¬ìœ </h3>
                        </div>
                        <span class="text-xs font-medium px-3 py-1 rounded-full bg-gray-100 text-gray-500">ê²€í†  ëŒ€ê¸°ì¤‘</span>
                    </div>
                    <div class="flex justify-between items-end border-t border-gray-50 pt-3">
                        <p class="text-xs text-[#A89080]">2026.01.16</p>
                        <span class="text-xs font-bold text-[#A89080]">ìƒì„¸ë³´ê¸° ì¤€ë¹„ì¤‘</span>
                    </div>
                </div>

                <div th:if="${dummyReports == null or dummyReports.isEmpty()}"
                     class="py-20 text-center bg-white rounded-2xl border border-dashed border-[#E8D5C4]">
                    <p class="text-[#A89080]">í˜„ì¬ ì‹ ê³ ëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤. ğŸ˜Š</p>
                </div>
            </div>
        </div>

        <div id="content-account" class="hidden space-y-6">
            <h3 class="text-xl font-bold text-[#5A4D41] mb-6">ê³„ì • ê´€ë¦¬</h3>

            <form th:action="@{/user/mypage/update}" method="post"
                  class="bg-white p-8 rounded-2xl border border-[#E8D5C4]/30 shadow-sm space-y-6">

                <div>
                    <label class="block text-xs text-[#A89080] mb-1">ì•„ì´ë””</label>
                    <div class="p-4 bg-[#F9F6F1] rounded-xl text-[#5A4D41] font-medium"
                         th:text="${user != null ? user.loginId : 'N/A'}">userid
                    </div>
                </div>

                <div>
                    <label class="block text-xs text-[#A89080] mb-1">ë‹‰ë„¤ì„ ìˆ˜ì •</label>
                    <input type="text" name="nickname"
                           th:value="${user != null ? user.nickname : ''}"
                           class="w-full p-4 bg-[#F9F6F1] rounded-xl text-[#5A4D41] border-none focus:ring-1 focus:ring-[#D4C4B0]">
                </div>

                <div>
                    <label class="block text-xs text-[#A89080] mb-1">ì´ë©”ì¼ ìˆ˜ì •</label>
                    <input type="email" name="email"
                           th:value="${user != null ? user.email : ''}"
                           class="w-full p-4 bg-[#F9F6F1] rounded-xl text-[#5A4D41] border-none focus:ring-1 focus:ring-[#D4C4B0]">
                </div>

                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

                <div class="password-management" style="margin-top: 40px !important;">
                    <div style="border-top: 1px dashed #e2ddd9 !important; margin-bottom: 35px !important;"></div>

                    <h3 style="font-family: 'Pretendard', sans-serif !important; font-size: 20px !important; color: #4a4a4a !important; margin-bottom: 25px !important; font-weight: 600 !important;">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>

                    <div class="form-group" style="margin-bottom: 20px !important;">
                        <label class="form-label" style="display: block !important; font-size: 13px !important; color: #8c8c8c !important; margin-bottom: 10px !important;">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                        <div class="input-with-button" style="display: flex !important; gap: 10px !important;">
                            <div style="flex: 1; position: relative;">
                                <input type="password" id="newPassword" class="form-input"
                                       style="width: 100% !important; padding: 20px !important; border: none !important; border-radius: 12px !important; background-color: #f6f3f0 !important; font-size: 15px !important; color: #4a4a4a !important;"
                                       placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
                                <i class="fa-regular fa-eye" id="toggleNewPw"
                                   onclick="togglePwVisibility('newPassword', 'toggleNewPw')"
                                   style="position: absolute; right: 18px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #b0b0b0;"></i>
                            </div>
                            <div style="width: 100px;"></div>
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 10px !important;">
                        <label class="form-label" style="display: block !important; font-size: 13px !important; color: #8c8c8c !important; margin-bottom: 10px !important;">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                        <div class="input-with-button" style="display: flex !important; gap: 10px !important;">
                            <div style="flex: 1; position: relative;">
                                <input type="password" id="confirmPassword" class="form-input"
                                       style="width: 100% !important; padding: 20px !important; border: none !important; border-radius: 12px !important; background-color: #f6f3f0 !important; font-size: 15px !important; color: #4a4a4a !important;"
                                       placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸">
                                <i class="fa-regular fa-eye" id="toggleConfirmPw"
                                   onclick="togglePwVisibility('confirmPassword', 'toggleConfirmPw')"
                                   style="position: absolute; right: 18px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #b0b0b0;"></i>
                            </div>
                            <button type="button" class="btn-check" onclick="updatePassword()"
                                    style="width: 100px !important; background-color: #6d6158 !important; color: white !important; border: none !important; border-radius: 12px !important; font-weight: bold !important; cursor: pointer !important; font-size: 15px !important;">
                                ë³€ê²½
                            </button>
                        </div>
                    </div>

                    <p id="pw-msg" style="text-align: left !important; font-size: 12px !important; margin-left: 5px !important; color: #e74c3c !important; min-height: 20px !important;"></p>
                </div>


                <div class="pt-4 border-t border-[#E8D5C4]/20">
                    <label class="block text-xs text-red-400 mb-1 font-bold italic underline">ë³´ì•ˆ í™•ì¸: í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" name="currentPassword" required
                           placeholder="ì •ë³´ ìˆ˜ì •ì„ ìœ„í•´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”"
                           class="w-full p-4 bg-[#FFFBF8] rounded-xl text-[#5A4D41] border border-red-100 focus:ring-1 focus:ring-red-200 outline-none">
                    <p th:if="${error}" class="text-xs text-red-500 mt-2" th:text="${error}"></p>
                </div>

                <button type="submit"
                        class="w-full py-4 bg-[#D4C4B0] text-white font-semibold rounded-xl hover:bg-[#C9B5A0] transition-colors shadow-sm">
                    í”„ë¡œí•„ ìˆ˜ì • ì™„ë£Œ
                </button>
            </form>

            <div class="bg-white p-8 rounded-2xl border border-[#E8D5C4]/30 shadow-sm">
                <div class="pt-2">
                    <p class="text-red-400 text-sm font-bold mb-3 flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                        ìœ„í—˜ ì˜ì—­
                    </p>

                    <form th:action="@{/user/mypage/delete}" method="post">

                        <div class="mb-4">
                            <label class="block text-sm text-[#8B7355] mb-2 font-bold">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>

                            <input type="password"
                                   name="password"
                                   placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                                   required
                                   class="w-full p-3 border border-[#E8D5C4] rounded-xl focus:outline-none focus:ring-1 focus:ring-[#8B7355]">
                        </div>

                        <button type="submit"
                                class="w-full py-3 bg-red-400 text-white rounded-xl font-bold hover:bg-red-500 transition-all"
                                onclick="return confirm('ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                            íƒˆí‡´ ì‹œ ëª¨ë“  ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.
                        </button>

                    </form>
                </div>
            </div>
        </div>
        </div>
    </section>
</main>

<script>
    function switchTab(tabName) {
        const activityContent = document.getElementById('content-activity');
        const accountContent = document.getElementById('content-account');
        const reportsContent = document.getElementById('content-reports'); // âœ… ì¶”ê°€

        const activityBtn = document.getElementById('tab-btn-activity');
        const accountBtn = document.getElementById('tab-btn-account');
        const reportsBtn = document.getElementById('tab-btn-reports'); // âœ… ì¶”ê°€

        const activeClass = "w-full flex justify-between items-center p-4 rounded-xl transition-all bg-[#D4C4B0] text-white shadow-sm";
        const inactiveClass = "w-full flex justify-between items-center p-4 rounded-xl transition-all bg-white text-[#8B7355] border border-[#E8D5C4]/50 hover:bg-[#F2ECE4]";

        if (tabName === 'activity') {
            activityContent.classList.remove('hidden');
            accountContent.classList.add('hidden');
            reportsContent.classList.add('hidden'); // âœ… ì¶”ê°€
            activityBtn.className = activeClass;
            accountBtn.className = inactiveClass;
            reportsBtn.className = inactiveClass; // âœ… ì¶”ê°€
        } else if (tabName === 'reports') { // âœ… ì‹ ê³  ë‚´ì—­ ë¡œì§ ì¶”ê°€
            activityContent.classList.add('hidden');
            accountContent.classList.add('hidden');
            reportsContent.classList.remove('hidden');
            activityBtn.className = inactiveClass;
            accountBtn.className = inactiveClass;
            reportsBtn.className = activeClass;
        } else {
            activityContent.classList.add('hidden');
            accountContent.classList.remove('hidden');
            reportsContent.classList.add('hidden'); // âœ… ì¶”ê°€
            accountBtn.className = activeClass;
            activityBtn.className = inactiveClass;
            reportsBtn.className = inactiveClass; // âœ… ì¶”ê°€
        }
    }
    function updatePassword() {
        const currentPw = document.querySelector('input[name="currentPassword"]').value;
        const newPw = document.getElementById('newPassword').value;
        const confirmPw = document.getElementById('confirmPassword').value;
        const msg = document.getElementById('pw-msg');

        // 1. ìœ íš¨ì„± ì²´í¬
        if (!currentPw) {
            alert("í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì•¼ ë³€ê²½ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            return;
        }
        if (!newPw || newPw.length < 6) {
            alert("ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }
        if (newPw !== confirmPw) {
            msg.innerText = "ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
            msg.style.color = "red";
            return;
        }

        // 2. ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡ (AJAX)
        const formData = new URLSearchParams();
        formData.append('currentPassword', currentPw);
        formData.append('newPassword', newPw);

        fetch('/user/update-pw', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: formData
        })
            .then(res => {
                if (res.ok) {
                    alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ë³´ì•ˆì„ ìœ„í•´ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                    location.href = "/user/logout"; // ë³€ê²½ í›„ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ (ê¶Œì¥)
                } else if (res.status === 400) {
                    alert("í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
                } else {
                    alert("ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            })
            .catch(err => console.error("Error:", err));
    }
    // ë¹„ë°€ë²ˆí˜¸ ë³´ê¸°/ê°€ë¦¬ê¸° í† ê¸€ í•¨ìˆ˜
    function togglePwVisibility(inputId, iconId) {
        const pwInput = document.getElementById(inputId);
        const icon = document.getElementById(iconId);

        if (pwInput.type === 'password') {
            pwInput.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash'); // ëˆˆ ê°€ë¦¬ê¸° ì•„ì´ì½˜ìœ¼ë¡œ ë³€ê²½
            icon.style.color = "#6d6158"; // ê°•ì¡° ìƒ‰ìƒ
        } else {
            pwInput.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye'); // ë‹¤ì‹œ ëˆˆ ì•„ì´ì½˜ìœ¼ë¡œ ë³€ê²½
            icon.style.color = "#ccc";
        }
    }
</script>

<div th:replace="~{layout/header :: commonScript}"></div>
</body>
</html>