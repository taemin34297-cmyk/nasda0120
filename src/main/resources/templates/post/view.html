<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <th:block th:replace="~{layout/header :: head}"></th:block>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@12/swiper-bundle.min.css" />
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body class="min-h-screen bg-white">

<div th:replace="~{layout/header :: header}"></div>
<div data-post-id="" th:data-post-id="${post.id}"></div>

<main class="view-container">
    <div class="view-header">
        <button onclick="window.location.href='/'" class="btn-back-inline">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2">
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
            Î™©Î°ùÏúºÎ°ú
        </button>
    </div>

    <div class="post-layout-grid">

        <article class="post-detail">
            <div class="post-detail-header">
                <div>
                    <div class="post-category-badge" th:text="${post.category}">Ïπ¥ÌÖåÍ≥†Î¶¨</div>
                    <h1 class="post-detail-title" th:text="${post.title}">Í≤åÏãúÎ¨º Ï†úÎ™©</h1>
                </div>

                <div class="post-meta-info">
                    <div class="post-author-info">
                        <div class="author-avatar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                        </div>
                        <div>
                            <span class="author-name" th:text="${post.author.nickname}">ÏûëÏÑ±Ïûê</span>
                            <span class="post-date"
                                  th:text="${#temporals.format(post.createdAt, 'yyyy.MM.dd HH:mm')}">2024.01.01</span>
                        </div>
                    </div>

                    <!-- ‚úÖ Í≤åÏãúÍ∏Ä ÏàòÏ†ï/ÏÇ≠Ï†ú: Ïö∞Î¶¨Í∞Ä ÎßåÎì† URLÎ°úÎßå Ïó∞Í≤∞ -->
                    <div th:if="${post.isOwner}" class="post-actions">
                        <a th:href="@{/posts/edit/{id}(id=${post.id})}" class="btn-action btn-edit">ÏàòÏ†ï</a>
                        <form th:action="@{/posts/{id}/delete(id=${post.id})}" method="post" style="display:inline;">
                            <button type="submit"
                                    class="btn-action btn-delete"
                                    onclick="return confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?');">
                                ÏÇ≠Ï†ú
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- ‚úÖ Í≤åÏãúÍ∏Ä Ïù¥ÎØ∏ÏßÄ (Ï≤´ Ïù¥ÎØ∏ÏßÄÎ∂ÄÌÑ∞ ÎÑòÍ∏∞Îäî Swiper 1Í∞úÎ°ú) -->
            <div th:if="${post.images != null and !post.images.isEmpty()}" class="post-images">

                <div class="swiper postImagesSwiper">
                    <div class="swiper-wrapper">

                        <th:block th:each="image, iter : ${post.images}">

                            <!-- ‚úÖ Ï≤´ Î≤àÏß∏ Ïä¨ÎùºÏù¥Îìú: Íæ∏ÎØ∏Í∏∞ Ï∫îÎ≤ÑÏä§(Ïä§Ìã∞Ïª§) Ïú†ÏßÄ -->
                            <div class="swiper-slide" th:if="${iter.first}">
                                <div id="sticker-canvas"
                                     class="sticker-canvas relative rounded-2xl overflow-hidden bg-[#F9F6F1]">
                                    <img th:src="@{${image}}" th:alt="${post.title}"
                                         class="post-image select-none w-full h-full block">
                                    <div id="sticker-layer" class="absolute inset-0 pointer-events-none overflow-hidden"></div>
                                </div>
                            </div>

                            <!-- ‚úÖ 2Î≤àÏß∏~: ÏùºÎ∞ò Ïù¥ÎØ∏ÏßÄ -->
                            <div class="swiper-slide" th:unless="${iter.first}">
                                <img th:src="@{${image}}" th:alt="${post.title}" class="post-image w-full h-full block">
                            </div>

                        </th:block>

                    </div>

                    <!-- ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò(Ï†ê) -->
                    <div class="swiper-pagination"></div>

                    <!-- Ï¢å/Ïö∞ Î≤ÑÌäº -->
                    <div class="swiper-button-prev"></div>
                    <div class="swiper-button-next"></div>
                </div>

            </div>

            <div class="post-content">
                <p th:text="${post.content}" style="white-space: pre-wrap;">Í≤åÏãúÎ¨º ÎÇ¥Ïö©</p>
            </div>
        </article>

        <aside class="comments-section">
            <div class="comments-sticky-wrapper">

                <!-- ===== Íæ∏ÎØ∏Í∏∞ Ìå®ÎÑê (Í∏∞Ï°¥ Ïú†ÏßÄ) ===== -->
                <div class="decoration-panel mb-8 p-6 bg-[#F9F6F1] rounded-2xl">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="text-xl">‚ú®</span>
                        <h3 class="text-[#8B7355] font-serif text-lg font-bold">Íæ∏ÎØ∏Í∏∞</h3>
                    </div>

                    <div id="deco-start-view">
                        <button onclick="startDecoration()"
                                class="w-full py-3 bg-[#D4C4B0] text-white rounded-xl hover:bg-[#C9B5A0] transition-all font-medium cursor-pointer">
                            Íæ∏ÎØ∏Í∏∞ ÏãúÏûë
                        </button>
                    </div>

                    <div id="deco-active-view" class="hidden space-y-4">
                        <p class="text-xs text-[#8B7355]">Ïä§Ìã∞Ïª§Î•º ÎìúÎûòÍ∑∏ÌïòÏó¨ Ïù¥ÎØ∏ÏßÄÏóê ÎÜìÏïÑÎ≥¥ÏÑ∏Ïöî!</p>

                        <div class="grid grid-cols-5 gap-2 bg-white p-3 rounded-xl" id="sticker-palette"></div>

                        <div class="flex gap-2">
                            <button onclick="saveDecoration()"
                                    class="flex-1 py-2 bg-[#8B7355] text-white rounded-lg hover:bg-[#A89080] text-sm cursor-pointer">
                                Ï†ÄÏû•
                            </button>
                            <button onclick="cancelDecoration()"
                                    class="flex-1 py-2 bg-[#E8D5C4] text-[#8B7355] rounded-lg hover:bg-[#D4C4B0] text-sm cursor-pointer">
                                Ï∑®ÏÜå
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ÎåìÍ∏Ä ÌÉÄÏù¥ÌãÄ -->
                <h2 class="comments-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                         viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>

                    <!-- ‚úÖ FIX: totalComments ÎåÄÏã† commentsPage.totalElements ÏÇ¨Ïö© -->
                    <span id="comment-count-text"
                          th:text="'ÎåìÍ∏Ä ' + ${(commentsPage != null) ? commentsPage.totalElements : 0} + 'Í∞ú'">
                        ÎåìÍ∏Ä 0Í∞ú
                    </span>
                </h2>

                <!-- ‚úÖ ÎåìÍ∏Ä ÏûëÏÑ± Ìèº -->
                <form id="comment-form"
                      class="comment-form"
                      th:data-post-id="${post.id}"
                      th:action="@{/comments}"
                      method="post">

                    <input type="hidden" name="postId" th:value="${post.id}">
                    <textarea id="comment-content"
                              name="content"
                              placeholder="Îî∞ÎúªÌïú ÎåìÍ∏ÄÏùÑ ÎÇ®Í≤®Ï£ºÏÑ∏Ïöî..."
                              class="comment-textarea"
                              maxlength="500"></textarea>

                    <div class="comment-form-footer">
                        <span id="comment-char-count" class="char-count">0/500</span>
                        <button type="submit" class="btn-submit-comment">Îì±Î°ù</button>
                    </div>
                </form>

                <!-- ‚úÖ ÎåìÍ∏Ä Î¶¨Ïä§Ìä∏ -->
                <div id="comments-list" class="comments-list">
                    <div th:if="${comments == null or #lists.isEmpty(comments)}" class="no-comments">
                        ÏïÑÏßÅ ÎåìÍ∏ÄÏù¥ ÏóÜÏñ¥Ïöî. Ï≤´ ÎåìÍ∏ÄÏùÑ ÎÇ®Í≤®Î≥¥ÏÑ∏Ïöî!
                    </div>

                    <div class="comment-item"
                         th:each="c : ${comments}"
                         th:attr="data-comment-id=${c.id}">

                        <div class="comment-card">
                            <div class="comment-content-view">
                                <p class="comment-text" th:text="${c.content}">ÎåìÍ∏Ä ÎÇ¥Ïö©</p>

                                <div class="comment-bottom-row">
                                    <div class="comment-left-meta">
                                        <span class="comment-author" th:text="${c.authorNickname}">ÏûëÏÑ±Ïûê</span>
                                        <span class="comment-date"
                                              th:text="${#temporals.format(c.createdAt, 'yyyyÎÖÑ MÏõî dÏùº')}">2026ÎÖÑ 1Ïõî 12Ïùº</span>
                                    </div>

                                    <div class="comment-actions">
                                        <!-- ÏàòÏ†ï -->
                                        <button type="button"
                                                class="icon-btn btn-comment-edit"
                                                title="ÏàòÏ†ï"
                                                th:if="${c.canEdit}">
                                            ‚úèÔ∏è
                                        </button>

                                        <!-- ÏÇ≠Ï†ú -->
                                        <form th:if="${c.canEdit}"
                                              th:action="@{/comments/{id}/delete(id=${c.id})}"
                                              method="post"
                                              class="inline-form">
                                            <button type="submit" class="icon-btn btn-comment-delete" title="ÏÇ≠Ï†ú">üóëÔ∏è</button>
                                        </form>

                                        <!-- Ïã†Í≥† -->
                                        <button type="button"
                                                class="icon-btn btn-comment-report"
                                                title="Ïã†Í≥†">
                                            ‚ö†Ô∏è
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- ‚úÖ ÏàòÏ†ï Î™®Îìú -->
                            <div class="comment-edit-box hidden">
                                <form th:action="@{/comments/{id}/edit(id=${c.id})}" method="post">
                                    <textarea class="comment-edit-textarea" name="content" maxlength="500"
                                              th:text="${c.content}"></textarea>

                                    <div class="comment-edit-actions">
                                        <button type="submit" class="btn-edit-save">Ï†ÄÏû•</button>
                                        <button type="button" class="btn-edit-cancel">Ï∑®ÏÜå</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ‚úÖ ÎåìÍ∏Ä ÌéòÏù¥Ïßï (0-based: commentsPage Í∏∞Ï§ÄÏúºÎ°ú Î†åÎçîÎßÅ) -->
                <div class="comment-pagination"
                     th:if="${commentsPage != null and commentsPage.totalPages > 1}">

                    <!-- Ïù¥Ï†Ñ -->
                    <a class="btn-page"
                       th:if="${commentsPage.hasPrevious()}"
                       th:href="@{/post/view.html(id=${post.id}, page=${commentsPage.number - 1}, size=${commentsPage.size})}">
                        Ïù¥Ï†Ñ
                    </a>

                    <!-- ÌéòÏù¥ÏßÄ Î≤àÌò∏ -->
                    <th:block th:each="p : ${#numbers.sequence(0, commentsPage.totalPages - 1)}">
                        <a class="btn-page page-number"
                           th:classappend="${commentsPage.number == p} ? ' active' : ''"
                           th:href="@{/post/view.html(id=${post.id}, page=${p}, size=${commentsPage.size})}"
                           th:text="${p + 1}">
                            1
                        </a>
                    </th:block>

                    <!-- Îã§Ïùå -->
                    <a class="btn-page"
                       th:if="${commentsPage.hasNext()}"
                       th:href="@{/post/view.html(id=${post.id}, page=${commentsPage.number + 1}, size=${commentsPage.size})}">
                        Îã§Ïùå
                    </a>
                </div>

            </div>
        </aside>

    </div>
</main>

<script th:src="@{/js/main.js}"></script>
<script th:src="@{/js/comment.js}"></script>
<script th:src="@{/js/post.js}"></script>

<!-- Ïä§Ìã∞Ïª§ Î°úÏßÅ(Í∏∞Ï°¥ Ïú†ÏßÄ) -->
<script th:inline="none">
    const availableStickers = [
        '‚ù§Ô∏è', '‚≠ê', '‚ú®', 'üåü', 'üíñ', 'üåà', 'üå∏', 'üå∫', 'üåª', 'üåº',
        'ü¶ã', 'üéÄ', 'üíï', 'üíù', 'üéâ', 'üéä', 'üåô', '‚òÄÔ∏è', 'üåû', 'üî•'
    ];

    let stickers = [];
    let isDecorating = false;

    const decoStartView = document.getElementById('deco-start-view');
    const decoActiveView = document.getElementById('deco-active-view');
    const stickerLayer = document.getElementById('sticker-layer');
    const stickerCanvas = document.getElementById('sticker-canvas');
    const stickerPalette = document.getElementById('sticker-palette');

    function initPalette() {
        if (!stickerPalette) return;
        stickerPalette.innerHTML = '';
        availableStickers.forEach(emoji => {
            const div = document.createElement('div');
            div.className = 'palette-item';
            div.textContent = emoji;
            div.draggable = true;
            div.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('emoji', emoji);
                e.dataTransfer.effectAllowed = 'copy';
            });
            stickerPalette.appendChild(div);
        });
    }

    function startDecoration() {
        if (!stickerLayer) return;
        isDecorating = true;
        if (decoStartView) decoStartView.classList.add('hidden');
        if (decoActiveView) decoActiveView.classList.remove('hidden');
        stickerLayer.classList.remove('pointer-events-none');
        initPalette();
    }

    function cancelDecoration() {
        if (confirm('ÏûëÏÑ± Ï§ëÏù∏ ÎÇ¥Ïö©Ïù¥ ÏÇ¨ÎùºÏßëÎãàÎã§. Ï∑®ÏÜåÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
            isDecorating = false;
            stickers = [];
            renderStickers();
            if (decoStartView) decoStartView.classList.remove('hidden');
            if (decoActiveView) decoActiveView.classList.add('hidden');
            if (stickerLayer) stickerLayer.classList.add('pointer-events-none');
        }
    }

    function saveDecoration() {
        console.log('Ï†ÄÏû•Îêú Ïä§Ìã∞Ïª§:', stickers);
        alert('Íæ∏ÎØ∏Í∏∞Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!');
        isDecorating = false;
        if (decoStartView) decoStartView.classList.remove('hidden');
        if (decoActiveView) decoActiveView.classList.add('hidden');
        if (stickerLayer) stickerLayer.classList.add('pointer-events-none');
    }

    if (stickerCanvas) {
        stickerCanvas.addEventListener('dragover', (e) => {
            if (!isDecorating) return;
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        });

        stickerCanvas.addEventListener('drop', (e) => {
            if (!isDecorating) return;
            e.preventDefault();
            const emoji = e.dataTransfer.getData('emoji');

            if (emoji) {
                const rect = stickerCanvas.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;
                addSticker(emoji, x, y);
            }
        });
    }

    function addSticker(emoji, x, y) {
        stickers.push({
            id: Date.now() + Math.random(),
            emoji, x, y
        });
        renderStickers();
    }

    function removeSticker(id) {
        stickers = stickers.filter(s => s.id !== id);
        renderStickers();
    }

    function renderStickers() {
        if (!stickerLayer) return;
        stickerLayer.innerHTML = '';
        stickers.forEach(sticker => {
            const el = document.createElement('div');
            el.className = 'sticker-item group';
            el.style.left = sticker.x + '%';
            el.style.top = sticker.y + '%';

            el.innerHTML = `
                <span>${sticker.emoji}</span>
                ${isDecorating ? `<div class="sticker-remove-btn">√ó</div>` : ''}
            `;

            if (isDecorating) {
                const btn = el.querySelector('.sticker-remove-btn');
                if (btn) {
                    btn.onclick = (e) => {
                        e.stopPropagation();
                        removeSticker(sticker.id);
                    };
                }
            }
            stickerLayer.appendChild(el);
        });
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/swiper@12/swiper-bundle.min.js"></script>
<script>
    (function () {
        const root = document.querySelector(".postImagesSwiper");
        if (!root) return;

        new Swiper(root, {
            slidesPerView: 1,
            spaceBetween: 12,
            pagination: {
                el: root.querySelector(".swiper-pagination"),
                clickable: true,
            },
            navigation: {
                nextEl: root.querySelector(".swiper-button-next"),
                prevEl: root.querySelector(".swiper-button-prev"),
            },
        });
    })();
</script>
</body>
</html>